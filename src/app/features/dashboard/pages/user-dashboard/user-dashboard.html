<app-table-layout
  [tableTitle]="'dashboard.title' | translate"
  [tableSubTitle]="dashboardSubtitle() | translate"
  pageTitleClass="text-[24px] font-semibold"
  pageSubTitleClass="text-md text-gray-600"
>

  <!-- Create New Plan Button (Investor only) -->
  @if (isInvestor()) {
  <ng-container ngProjectAs="table-actions">
    <p-button
      [label]="'dashboard.submitNewPlan' | translate"
      [icon]="'icon-plus'"
      [size]="'small'"
      (onClick)="createNewPlan()"
    />
  </ng-container>
  }

  <!-- Statistics Cards -->
  <ng-container ngProjectAs="table-filters">
    @if (isInvestor()) {
    <div class="w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      @if(isStatisticsLoading()) {
      <app-dashboard-statistics-skeleton [count]="4" />
      } @else {
      <app-dashboard-statistics-cards
        [statistics]="statistics()"
        (onViewTotalPlans)="onViewTotalPlans()"
        (onViewPlansUnderReview)="onViewPlansUnderReview()"
        (onViewApprovedPlans)="onViewApprovedPlans()"
        (onViewRejectedPlans)="onViewRejectedPlans()"
      />
      }
    </div>
    } @else {
    <div class="w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
      @if(isStatisticsLoading()) {
      <app-dashboard-statistics-skeleton [count]="5" />
      } @else {
      <app-dashboard-statistics-cards
        [statistics]="statistics()"
        (onViewTotalPlans)="onViewTotalPlans()"
        (onViewUnassignedPlans)="onViewUnassignedPlans()"
        (onViewPlansUnderReview)="onViewPlansUnderReview()"
        (onViewApprovedPlans)="onViewApprovedPlans()"
        (onViewRejectedPlans)="onViewRejectedPlans()"
        (onViewPendingAssignedPlans)="onViewPendingAssignedPlans()"
        (onViewAssignedPlans)="onViewAssignedPlans()"
      />
      }
    </div>
    }

    <!-- Filters -->
    @if (isInvestor()) {
    <app-investor-dashboard-plans-filter></app-investor-dashboard-plans-filter>
    } @else {
    <app-internal-users-dashboard-plans-filter></app-internal-users-dashboard-plans-filter>
    }
  </ng-container>

  <ng-container ngProjectAs="table-body">
    <app-table-skeleton
      [headers]="headers()"
      [isLoading]="isLoading()"
    >
      <app-data-table
        [columns]="headers()"
        [rows]="rows()"
        [(filter)]="filterService().filter"
        [totalRecords]="totalRecords()"
        (filterChange)="filterService().applyFilterWithPaging()"
        [messageTitle]="'plans.list.noPlansFound' | translate"
        [showCheckBox]="false"
        [rowsCheckable]="false"
      >
        <ng-template
          #itemsTemplate
          let-item="item"
        >
          <td>
            {{ '#' + item.planCode }}
          </td>
          @if (isInternalUser()) {
          <td>
            <p
              class="text-sm text-gray-900 font-medium max-w-[25ch]"
              [appTruncateTooltip]="item.investorName ?? '-'"
              [maxChars]="20"
            >{{ item.investorName ?? '-' }}</p>
          </td>
          }
          <td>
            <p
              class="text-sm text-gray-900 font-medium max-w-[25ch]"
              [appTruncateTooltip]="item.title"
              [maxChars]="20"
            >
              {{ item.title }}</p>
          </td>
          <td>
            <span class="text-sm text-gray-600">{{ getPlanTypeLabel(item.planType) }}</span>
          </td>
          <td>{{ item.submissionDate | date : 'dd MMM yyyy' }}</td>
          @if (isManager()) {
          <td>
            <p
              class="text-sm text-gray-900 font-medium max-w-[25ch]"
              [appTruncateTooltip]="getAssigneeName(item.assignedEmployee)"
              [maxChars]="20"
            >
              {{ getAssigneeName(item.assignedEmployee) }}
            </p>
          </td>
          }
          <td>
            @if (isInvestor()) {
            @if(item.status == EInvestorPlanStatus.PENDING) {
            <span
              class="text-sm font-medium"
              [ngClass]="
                    item.slaCountDown > 5
                      ? 'text-green-500'
                      : item.slaCountDown > 0
                      ? 'text-orange-500'
                      : 'text-red-600'
                  "
            >
              {{ item.slaCountDown | slaCountdownNoun }}
            </span>
            } @else {
            <span class="text-sm font-medium text-center">-</span>
            }
            } @else {
            @if(item.status !== EInternalUserPlanStatus.UNASSIGNED) {
            <span
              class="text-sm font-medium"
              [ngClass]="
                    item.slaCountDown > 5
                      ? 'text-green-500'
                      : item.slaCountDown > 0
                      ? 'text-orange-500'
                      : 'text-red-600'
                  "
            >
              {{ item.slaCountDown | slaCountdownNoun }}
            </span>
            } @else {
            <span class="text-sm font-medium">-</span>
            }
            }
          </td>
          <td>
            <app-base-tag
              [value]="getStatusBadge(item.status).label"
              [color]="getStatusBadge(item.status).color"
              [maxChars]="25"
            ></app-base-tag>
          </td>
          <td>
            <app-dashboard-plan-action-menu
              [actions]="item.actions"
              [plan]="item"
              (onViewDetails)="onViewDetails($event)"
              (onEdit)="onEdit($event)"
              (onDownload)="onDownload($event)"
              (onViewTimeLine)="onViewTimeline($event)"
              (onAssignToEmployee)="onAssignToEmployee($event)"
              (onReAssign)="onReAssign($event)"
              (onInternalReview)="onReview($event)"
              (onResubmitted)="onResubmitted($event)"
            />
          </td>
        </ng-template>
      </app-data-table>
    </app-table-skeleton>
  </ng-container>
</app-table-layout>

<!-- Dialogs and Wizards -->
@if (isInvestor()) {
@if(planTermsAndConditionsDialogVisibility()) {
<app-plan-terms-and-conditions-dialog
  [(visibility)]="planTermsAndConditionsDialogVisibility"
  (onConfirm)="onUserReadAndApproved()"
/>
}
@if(newPlanDialogVisibility()) {
<app-new-plan-dialog
  [(visibility)]="newPlanDialogVisibility"
  (onConfirm)="onUserConfirmNewPlanDialog()"
/>
}
}

@if (isInternalUser() && viewAssignDialog()) {
<app-assign-reassign-manual-employee
  [(dialogVisible)]="viewAssignDialog"
  [isReassignMode]="isReassignMode()"
  [planRecord]="planItem()"
  (onSuccess)="applyFilter()"
></app-assign-reassign-manual-employee>
}

@if(productLocalizationPlanWizardVisibility()) {
<app-product-localization-plan-wizard
  [(visibility)]="productLocalizationPlanWizardVisibility"
  (doRefresh)="applyFilter()"
/>
}

@if(serviceLocalizationPlanWizardVisibility()) {
<app-service-localization-plan-wizard
  [(visibility)]="serviceLocalizationPlanWizardVisibility"
  (doRefresh)="applyFilter()"
/>
}

@if(timelineVisibility()) {
<app-timeline-dialog
  [(dialogVisible)]="timelineVisibility"
  [planId]="planItem()?.id || selectedPlan()?.id || null"
/>
}