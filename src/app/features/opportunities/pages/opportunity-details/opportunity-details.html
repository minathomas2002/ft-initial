<div class="page-layout px-[32px] py-[24px]">
  <app-cards-skeleton [isLoading]="opportunitiesStore.loading()" [count]="6">
    <div class="page-layout--header mb-[20px]">
      <div class="flex items-center justify-between">
        <span
          class="flex items-center gap-2 text-primary-600 cursor-pointer mb-6"
          (click)="onBack()"
        >
          <i class="icon-arrow-left"></i>
          <span>{{ 'opportunity.details.backToOpportunities' | translate }}</span>
        </span>

        @if(this.permissionService.canAccessOnOpportunityAdmin()){
        @if((opportunitiesStore.details()?.actions?? []).length > 0) {
        <app-opportunity-action-menu
          [actions]="opportunitiesStore.details()?.actions ?? []"
          (onEdit)="onAction(EOpportunityAction.Edit)"
          (onDelete)="onAction(EOpportunityAction.Delete)"
          (onMoveToDraft)="onAction(EOpportunityAction.MoveToDraft)"
          (onPublish)="onAction(EOpportunityAction.Publish)"
          [hasLabel]="true"
        />
        } }@else{
        <p-button [label]="'opportunity.details.apply' | translate" (click)="onApply()"></p-button>
        }
      </div>

      <div class="page-layout--title sm:w-auto">
        <div class="flex gap-4 items-center justify-between">
          <div class="flex gap-4 items-center">
            <h2
              class="font-semibold text-[24px] line-clamp-1"
              [pTooltip]="opportunitiesStore.details()?.title"
              tooltipPosition="top"
            >
              {{ opportunitiesStore.details()?.title }}
            </h2>
            @if(opportunitiesStore.details()?.opportunityType) { @let opportunityTypeConfig =
            getOpportunityTypeConfig(opportunitiesStore.details()?.opportunityType!);
            <app-base-tag
              [color]="opportunityTypeConfig.color"
              [value]="opportunityTypeConfig.label | translate"
            />
            }
          </div>
        </div>
        <p class="text-md text-gray-600 break-word mb-1">
          {{ opportunitiesStore.details()?.shortDescription }}
        </p>
      </div>
    </div>
    <div class="cpage-layout--body">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-[64px] mb-[48px]">
        <div class="col-span-1 flex flex-col gap-[24px]">
          <div>
            <h5 class="text-[20px] font-semibold mb-2">
              {{ forecastedDemand() }}
            </h5>
            <p class="text-md text-gray-600 mb-4">
              {{ 'opportunity.details.demandNote' | translate }}
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <app-base-card
                icon="icon-curruncy-dollar-circle"
                [cardTitle]="'opportunity.details.spendSAR' | translate"
                cardClass="bg-white"
                cardDescription="{{
                  opportunitiesStore.details()?.spendSAR
                    ? opportunitiesStore.details()?.spendSAR + 'B'
                    : '-'
                }}"
              >
              </app-base-card>
              <app-base-card
                icon="icon-data"
                [cardTitle]="'opportunity.details.quantityUnits' | translate"
                cardClass="bg-white"
                cardDescription="{{ opportunitiesStore.details()?.maxQuantityFormatted }} - {{
                  opportunitiesStore.details()?.maxQuantityFormatted
                }}"
              >
              </app-base-card>
            </div>
          </div>
          <div>
            <h5 class="text-[20px] font-semibold mb-2">
              {{ 'opportunity.details.supplierBase' | translate }}
            </h5>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <app-base-card
                icon="icon-flag"
                [cardTitle]="'opportunity.details.local' | translate"
                cardClass="bg-white"
                cardDescription="{{
                  opportunitiesStore.details()?.localSuppliersFormatted == '0'
                    ? '-'
                    : opportunitiesStore.details()?.localSuppliersFormatted + '+'
                }}"
              >
              </app-base-card>
              <app-base-card
                icon="icon-glop-04"
                [cardTitle]="'opportunity.details.global' | translate"
                cardClass="bg-white"
                cardDescription="{{
                  opportunitiesStore.details()?.globalSuppliersFormatted == '0'
                    ? '-'
                    : opportunitiesStore.details()?.globalSuppliersFormatted + '+'
                }}"
              >
              </app-base-card>
            </div>
          </div>
        </div>

        <!-- image section -->
        <div class="col-span-1">
          <div>
            <img
              [src]="opportunityAttachmentBase64"
              alt=""
              class="ms-auto img-fluid"
              appImageError
            />
          </div>
        </div>
      </div>
      <div>
        <h5 class="text-[20px] font-semibold mb-5">
          {{ 'opportunity.details.localizationAreas' | translate }}
        </h5>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <app-base-card
            icon="icon-lighting-02"
            [cardTitle]="'opportunity.details.designEngineering' | translate"
            cardClass="bg-white md:min-h-[260px]"
          >
            <ng-container ngProjectAs="base-card-info">
              <div class="flex flex-col overflow-y-auto h-30 wrap break-word gap-1">
                @for(item of opportunitiesStore.details()?.designEngineerings; track item.id){
                <app-opportunity-details-card-info-item
                  icon="icon-check-circle"
                  label="{{ item.keyActivityFormatted }}"
                />
                }
              </div>
            </ng-container>
          </app-base-card>
          <app-base-card
            icon="icon-lighting-02"
            [cardTitle]="'opportunity.details.sourcing' | translate"
            cardClass="bg-white md:min-h-[260px]"
          >
            <ng-container ngProjectAs="base-card-info">
              <div class="flex flex-col overflow-y-auto h-30 wrap break-word gap-1">
                @for(item of opportunitiesStore.details()?.sourcings; track item.id){
                <app-opportunity-details-card-info-item
                  icon="icon-check-circle"
                  label="{{ item.keyActivityFormatted }}"
                />
                }
              </div>
            </ng-container>
          </app-base-card>
          <app-base-card
            icon="icon-lighting-02"
            [cardTitle]="'opportunity.details.manufacturing' | translate"
            cardClass="bg-white md:min-h-[260px]"
          >
            <ng-container ngProjectAs="base-card-info">
              <div class="flex flex-col overflow-y-auto h-30 wrap break-word gap-1">
                @for(item of opportunitiesStore.details()?.manufacturings; track item.id){
                <app-opportunity-details-card-info-item
                  icon="icon-check-circle"
                  label="{{ item.keyActivityFormatted }}"
                />
                }
              </div>
            </ng-container>
          </app-base-card>
          <app-base-card
            icon="icon-lighting-02"
            [cardTitle]="'opportunity.details.assemblyTesting' | translate"
            cardClass="bg-white md:min-h-[260px]"
          >
            <ng-container ngProjectAs="base-card-info">
              <div class="flex flex-col overflow-y-auto h-30 wrap break-word gap-1">
                @for(item of opportunitiesStore.details()?.assemblyTestings; track item.id){
                <app-opportunity-details-card-info-item
                  icon="icon-check-circle"
                  label="{{ item.keyActivityFormatted }}"
                />
                }
              </div>
            </ng-container>
          </app-base-card>
          <app-base-card
            icon="icon-lighting-02"
            [cardTitle]="'opportunity.details.afterSalesServices' | translate"
            cardClass="bg-white md:min-h-[260px]"
          >
            <ng-container ngProjectAs="base-card-info">
              <div class="flex flex-col overflow-y-auto h-30 wrap break-word gap-1">
                @for(item of opportunitiesStore.details()?.afterSalesServices; track item.id){
                <app-opportunity-details-card-info-item
                  icon="icon-check-circle"
                  label="{{ item.keyActivityFormatted }}"
                />
                }
              </div>
            </ng-container>
          </app-base-card>
        </div>
      </div>
    </div>
  </app-cards-skeleton>
</div>

@if(createEditOpportunityDialogVisible()){
<app-create-edit-opportunity-dialog
  [(visible)]="createEditOpportunityDialogVisible"
  (onSuccess)="getOpportunityDetails()"
/>
}

<app-general-confirmation-dialog
  [(visible)]="deleteConfirmDialogVisible"
  [title]="'dialog.deleteOpportunity' | translate"
  [description]="'dialog.deleteOpportunityDescription' | translate"
  [confirmationLabel]="'dialog.delete' | translate"
  [icon]="'icon-trash-2'"
  (confirmed)="deleteOpportunity()"
  [confirmButtonSeverity]="'danger'"
  [isLoading]="adminOpportunitiesStore.isProcessing()"
/>

<app-general-confirmation-dialog
  [(visible)]="moveToDraftConfirmDialogVisible"
  [title]="'dialog.moveToDraft' | translate"
  [confirmationLabel]="'dialog.draft' | translate"
  [icon]="'icon-save'"
  (confirmed)="moveToDraftOpportunity()"
  [isLoading]="adminOpportunitiesStore.isProcessing()"
/>

<app-general-confirmation-dialog
  [(visible)]="publishConfirmDialogVisible"
  [title]="'dialog.publishOpportunity' | translate"
  [confirmationLabel]="'dialog.publish' | translate"
  [icon]="'icon-cloud-upload'"
  (confirmed)="publishOpportunity()"
  [isLoading]="adminOpportunitiesStore.isProcessing()"
/>

@if(productLocalizationPlanWizardVisibility()){
<app-product-localization-plan-wizard [(visibility)]="productLocalizationPlanWizardVisibility" (doRefresh)="getOpportunityDetails()" />
} @if(serviceLocalizationPlanWizardVisibility()){
<app-service-localization-plan-wizard [(visibility)]="serviceLocalizationPlanWizardVisibility" (doRefresh)="getOpportunityDetails()" />
}
