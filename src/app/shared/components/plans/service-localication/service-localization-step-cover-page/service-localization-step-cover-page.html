<div class="flex flex-col gap-[32px] pb-10">
  <!-- Investor Comments Box (Orange) - Only in view mode -->
  @if (isViewMode() && investorComments().length > 0) {
    <div class="bg-orange-50 border border-orange-500 rounded-lg p-4 mb-4">
      <div class="flex flex-col gap-2">
        <h3 class="text-sm font-semibold text-orange-900">Investor Comments</h3>
        <p class="text-sm text-orange-800 whitespace-pre-line">{{ getCombinedCommentText() }}</p>
        @if (getCommentedFieldLabels()) {
          <p class="text-xs text-orange-700 mt-2">
            <span class="font-semibold">Fields:</span> {{ getCommentedFieldLabels() }}
          </p>
        }
      </div>
    </div>
  }

  <div class="flex flex-col gap-4">
    <h2 class="text-lg font-semibold text-gray-900">Company Information</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-1">
      <div class="flex flex-col gap-2 col-span-1">
        <app-base-label [title]="'Plan Title'" />

        <app-group-input-with-checkbox
          [showCheckbox]="showCheckbox()"
          [hasCommentControl]="
            getHasCommentControl(coverPageCompanyInformationFormGroup.get('planTitle'))
          "
          (valueChanged)="upDateSelectedInputs($event, {
            section: 'coverPageCompanyInformation',
            inputKey: 'planTitle',
            label: 'Plan Title'
          })"
        >
          <input
            pInputText
            placeholder="Enter plan title"
            [formControl]="getCoverPageValueControl('planTitle')"
            fluid
            maxlength="150"
            trimOnBlur
            [appConditionalColorClass]="isViewMode() ? isFieldCorrected('planTitle', 'coverPageCompanyInformation') : highlightInput('planTitle')"
            [color]="isViewMode() && isFieldCorrected('planTitle', 'coverPageCompanyInformation') ? 'green' : selectedInputColor()"
          />
        </app-group-input-with-checkbox>

        <app-base-error-messages
          [control]="getCoverPageValueControl('planTitle')"
          [label]="'Plan Title'"
        />
      </div>

      <div class="flex flex-col gap-2 col-span-1">
        <app-base-label [title]="'Company Name'" />

        <app-group-input-with-checkbox
          [showCheckbox]="showCheckbox()"
          [hasCommentControl]="
            getHasCommentControl(coverPageCompanyInformationFormGroup.get('companyName'))
          "
          (valueChanged)="upDateSelectedInputs($event, {
            section: 'coverPageCompanyInformation',
            inputKey: 'companyName',
            label: 'Company Name'
          })"
        >
          <input
            pInputText
            placeholder="Enter company name"
            [formControl]="getCoverPageValueControl('companyName')"
            fluid
            maxlength="100"
            trimOnBlur
              [appConditionalColorClass]="isViewMode() ? isFieldCorrected('companyName', 'coverPageCompanyInformation') : highlightInput('companyName')"
              [color]="isViewMode() && isFieldCorrected('companyName', 'coverPageCompanyInformation') ? 'green' : selectedInputColor()"
          />
        </app-group-input-with-checkbox>

        <app-base-error-messages
          [control]="getCoverPageValueControl('companyName')"
          [label]="'Company Name'"
        />
      </div>
    </div>
  </div>

  <div class="flex flex-col gap-4">
    <h2 class="text-lg font-semibold text-gray-900">Services</h2>
    <app-form-array-input
      [ft]="getServicesFormArray()"
      [hideAddButton]="isViewMode()"
      [hideDeleteButton]="isViewMode()"
      [addButtonMessage]="'Add Service'"
      [createNewItem]="createServiceItem"
      [excludeKeys]="['serviceId']"
    >
      <ng-template
        #itemTemplate
        let-itemControl
        let-index="index"
      >
        <td class="p-3 border border-gray-200 min-w-[300px]">
          <app-group-input-with-checkbox
            [hasCommentControl]="getHasCommentControl(itemControl.get('serviceName'))"
            [showCheckbox]="showCheckbox()"
            (valueChanged)="upDateSelectedInputs($event, {
              section: 'services',
              inputKey: 'serviceName_' + index,
              label: 'Service Name'
            }, itemControl.get('rowId')?.value)"
          >
            <input
              type="text"
              pInputText
              fluid
              placeholder="Enter service name"
              [maxlength]="100"
              [formControl]="getValueControl(itemControl.get('serviceName'))"
              trimOnBlur
              [appConditionalColorClass]="highlightInput('serviceName_' + index, itemControl.get('rowId')?.value)"
              [color]="selectedInputColor()"
            />
          </app-group-input-with-checkbox>

          <app-base-error-messages
            [control]="getValueControl(itemControl.get('serviceName'))"
            [label]="'Service Name'"
          />
        </td>
      </ng-template>
    </app-form-array-input>
  </div>

  @if(commentPhase() == 'editing' || commentPhase() == 'viewing'){
  <div
    class="animated flex flex-col gap-4 mt-8"
    animate.enter="fadeIn"
  >
    <div class="flex flex-col gap-4 md:flex-row">
      <div class="flex flex-col gap-2 flex-1">
        <app-base-label [title]="'Your Comment'" />
        <textarea
          fluid
          rows="8"
          pTextarea
          [formControl]="commentFormControl"
        ></textarea>
        <app-base-error-messages
          [control]="commentFormControl"
          [label]="'Your Comment'"
        />
      </div>
    </div>
  </div>
  }

  @if(showCheckbox()){
  <app-comment-state-component
    [commentsCount]="selectedInputs().length"
    [(commentPhase)]="commentPhase"
    [commentFormControl]="commentFormControl"
    (deleteComments)="onDeleteComments()"
    (saveComment)="commentPhase() === 'editing' ? onSaveEditedComment() : onSaveComment()"
  />
  }

  @if(showDeleteConfirmationDialog()){
  <app-general-confirmation-dialog
    [(visible)]="showDeleteConfirmationDialog"
    [title]="'Are you sure you want to delete the comment and selected fields?'"
    [confirmationLabel]="'Delete'"
    [cancelLabel]="'Cancel'"
    [confirmButtonSeverity]="'danger'"
    [icon]="'icon-trash-2'"
    (confirmed)="onConfirmDeleteComment()"
    (onCancel)="onCancelDeleteComment()"
  />
  }
</div>