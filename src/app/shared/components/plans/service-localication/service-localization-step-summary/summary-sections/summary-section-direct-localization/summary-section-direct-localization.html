<div class="flex flex-col gap-6 bg-white">
  <!-- Section Header -->
  <div class="flex flex-col gap-4">
    <app-summary-section-header
      [title]="'Direct Localization by Foreign Entity'"
      [isViewMode]="isViewMode()"
      (onEdit)="onEditClick()"
    />

    <!-- Localization Strategy -->
    <div class="flex flex-col gap-4">
      <h3 class="text-lg font-semibold text-[#4A4E5A]">Localization Strategy</h3>
      @if (localizationStrategy().length > 0) {
      <div class="overflow-x-auto">
        <div class="rounded-2xl overflow-hidden border border-gray-300">
          <p-table
            [value]="localizationStrategy()"
            [tableStyle]="{ 'border-collapse': 'collapse', width: '100%' }"
            styleClass="w-full [&_th]:!border-e [&_td]:!border-e [&_th]:!border-gray-300 [&_td]:!border-gray-300"
          >
            <ng-template pTemplate="header">
              <tr class="[&_th]:bg-[#F9FAFA]! [&_th]:text-[#4A4E5A]!">
                <th class="p-3 text-left text-sm font-semibold text-[#4A4E5A]!">Service Name</th>
                <th class="p-3 text-left text-sm font-semibold text-[#4A4E5A]!">Expected Localization Date</th>
                <th class="p-3 text-left text-sm font-semibold text-[#4A4E5A]!">Localization Approach</th>
                <th class="p-3 text-left text-sm font-semibold text-[#4A4E5A]!">Location</th>
                <th class="p-3 text-left text-sm font-semibold text-[#4A4E5A]!">CAPEX Required (SAR Million)</th>
                <th class="p-3 text-left text-sm font-semibold text-[#4A4E5A]!">Supervision/Oversight</th>
                <th class="p-3 text-left text-sm font-semibold text-[#4A4E5A]!">Proprietary Tools/Systems</th>
              </tr>
            </ng-template>

            <ng-template
              pTemplate="body"
              let-strategy
              let-rowIndex="rowIndex"
            >
              <tr>
                <td class="border-t border-gray-300 p-3">
                  <app-summary-table-cell
                    [value]="strategy.serviceName"
                    [isEmpty]="!strategy.serviceName"
                    [hasError]="hasLocalizationStrategyFieldError(rowIndex, 'serviceName')"
                    [hasComment]="hasLocalizationStrategyComment(rowIndex, 'serviceName')"
                    [beforeValue]="getBeforeValue('serviceName', 'localizationStrategy', rowIndex)"
                    [afterValue]="getAfterValue('serviceName', 'localizationStrategy', rowIndex)"
                    [isResolved]="isLocalizationStrategyResolved(rowIndex, 'serviceName')"
                    [showDiff]="shouldShowDiff('serviceName', 'localizationStrategy', rowIndex)"
                  />
                </td>
                <td class="border-t border-gray-300 p-3">
                  <app-summary-table-cell
                    [value]="strategy.expectedLocalizationDate"
                    [isEmpty]="!strategy.expectedLocalizationDate"
                    [hasError]="hasLocalizationStrategyFieldError(rowIndex, 'expectedLocalizationDate')"
                    [hasComment]="hasLocalizationStrategyComment(rowIndex, 'expectedLocalizationDate')"
                    [beforeValue]="getBeforeValue('expectedLocalizationDate', 'localizationStrategy', rowIndex)"
                    [afterValue]="getAfterValue('expectedLocalizationDate', 'localizationStrategy', rowIndex)"
                    [isResolved]="isLocalizationStrategyResolved(rowIndex, 'expectedLocalizationDate')"
                    [showDiff]="shouldShowDiff('expectedLocalizationDate', 'localizationStrategy', rowIndex)"
                  />
                </td>
                <td class="border-t border-gray-300 p-3">
                  <app-summary-table-cell
                    [value]="strategy.localizationApproach"
                    [isEmpty]="!strategy.localizationApproach"
                    [hasError]="hasLocalizationStrategyFieldError(rowIndex, 'localizationApproach')"
                    [hasComment]="hasLocalizationStrategyComment(rowIndex, 'localizationApproach')"
                    [beforeValue]="getBeforeValue('localizationApproach', 'localizationStrategy', rowIndex)"
                    [afterValue]="getAfterValue('localizationApproach', 'localizationStrategy', rowIndex)"
                    [isResolved]="isLocalizationStrategyResolved(rowIndex, 'localizationApproach')"
                    [showDiff]="shouldShowDiff('localizationApproach', 'localizationStrategy', rowIndex)"
                  />
                  @if (strategy.localizationApproachOther) {
                  <div class="mt-2 text-sm text-gray-600 flex items-center gap-2">
                    <span class="font-semibold">Other: </span>{{ strategy.localizationApproachOther }}
                    @if (hasLocalizationApproachOtherComment(rowIndex)) {
                    <i
                      class="icon-info text-orange-600 text-xs bg-orange-50 p-1 rounded-full"
                      pTooltip="This field has a comment"
                      tooltipPosition="top"
                    ></i>
                    }
                  </div>
                  }
                </td>
                <td class="border-t border-gray-300 p-3">
                  <app-summary-table-cell
                    [value]="strategy.location"
                    [isEmpty]="!strategy.location"
                    [hasError]="hasLocalizationStrategyFieldError(rowIndex, 'location')"
                    [hasComment]="hasLocalizationStrategyComment(rowIndex, 'location')"
                    [beforeValue]="getBeforeValue('location', 'localizationStrategy', rowIndex)"
                    [afterValue]="getAfterValue('location', 'localizationStrategy', rowIndex)"
                    [isResolved]="isLocalizationStrategyResolved(rowIndex, 'location')"
                    [showDiff]="shouldShowDiff('location', 'localizationStrategy', rowIndex)"
                  />
                  @if (strategy.locationOther) {
                  <div class="mt-2 text-sm text-gray-600 flex items-center gap-2">
                    <span class="font-semibold">Other: </span>{{ strategy.locationOther }}
                    @if (hasLocationOtherComment(rowIndex)) {
                    <i
                      class="icon-info text-orange-600 text-xs bg-orange-50 p-1 rounded-full"
                      pTooltip="This field has a comment"
                      tooltipPosition="top"
                    ></i>
                    }
                  </div>
                  }
                </td>
                <td class="border-t border-gray-300 p-3 text-center">
                  <app-summary-table-cell
                    [value]="strategy.capexRequired"
                    [isEmpty]="!strategy.capexRequired && strategy.capexRequired !== 0"
                    [hasError]="hasLocalizationStrategyFieldError(rowIndex, 'capexRequired (InSAR)')"
                    [hasComment]="hasLocalizationStrategyComment(rowIndex, 'capexRequired (InSAR)')"
                    [beforeValue]="getBeforeValue('capexRequired (InSAR)', 'localizationStrategy', rowIndex)"
                    [afterValue]="getAfterValue('capexRequired (InSAR)', 'localizationStrategy', rowIndex)"
                    [isResolved]="isLocalizationStrategyResolved(rowIndex, 'capexRequired (InSAR)')"
                    [showDiff]="shouldShowDiff('capexRequired (InSAR)', 'localizationStrategy', rowIndex)"
                  />
                </td>
                <td class="border-t border-gray-300 p-3">
                  <app-summary-table-cell
                    [value]="strategy.supervisionOversight"
                    [isEmpty]="!strategy.supervisionOversight"
                    [hasError]="hasLocalizationStrategyFieldError(rowIndex, 'supervisionOversightByGovernmentEntity')"
                    [hasComment]="hasLocalizationStrategyComment(rowIndex, 'supervisionOversightByGovernmentEntity')"
                    [beforeValue]="getBeforeValue('supervisionOversightByGovernmentEntity', 'localizationStrategy', rowIndex)"
                    [afterValue]="getAfterValue('supervisionOversightByGovernmentEntity', 'localizationStrategy', rowIndex)"
                    [isResolved]="isLocalizationStrategyResolved(rowIndex, 'supervisionOversightByGovernmentEntity')"
                    [showDiff]="shouldShowDiff('supervisionOversightByGovernmentEntity', 'localizationStrategy', rowIndex)"
                  />
                </td>
                <td class="border-t border-gray-300 p-3">
                  <app-summary-table-cell
                    [value]="strategy.proprietaryTools"
                    [isEmpty]="!strategy.proprietaryTools"
                    [hasError]="hasLocalizationStrategyFieldError(rowIndex, 'willBeAnyProprietaryToolsSystems')"
                    [hasComment]="hasLocalizationStrategyComment(rowIndex, 'willBeAnyProprietaryToolsSystems')"
                    [beforeValue]="getBeforeValue('willBeAnyProprietaryToolsSystems', 'localizationStrategy', rowIndex)"
                    [afterValue]="getAfterValue('willBeAnyProprietaryToolsSystems', 'localizationStrategy', rowIndex)"
                    [isResolved]="isLocalizationStrategyResolved(rowIndex, 'willBeAnyProprietaryToolsSystems')"
                    [showDiff]="shouldShowDiff('willBeAnyProprietaryToolsSystems', 'localizationStrategy', rowIndex)"
                  />
                  @if (strategy.proprietaryToolsExplanation) {
                  <div class="mt-2 text-sm text-gray-600 flex items-center gap-2">
                    <span class="font-semibold">Explanation: </span>{{ strategy.proprietaryToolsExplanation }}
                    @if (hasProprietaryToolsExplanationComment(rowIndex)) {
                    <i
                      class="icon-info text-orange-600 text-xs bg-orange-50 p-1 rounded-full"
                      pTooltip="This field has a comment"
                      tooltipPosition="top"
                    ></i>
                    }
                  </div>
                  }
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
      } @else {
      <p class="text-sm text-gray-500">No localization strategy added</p>
      }
    </div>

    <!-- Entity Level -->
    @if (entityLevel()) {
    <div class="flex flex-col gap-4">
      <h3 class="text-lg font-semibold text-[#4A4E5A]">Entity Level (i.e., local company responsible for delivering the services)</h3>
      <p class="text-sm font-normal text-[#4A4E5A]">Details to be provided for the KSA facility only considering only the workforce / employees directly responsible for delivering all the services you intend to localize by setting up local entity / branch / other</p>
      <div class="overflow-x-auto">
        <div class="rounded-2xl overflow-hidden border border-gray-300">
          <p-table
            [value]="entityLevel() ? [entityLevel()!] : []"
            [tableStyle]="{ 'border-collapse': 'collapse', width: '100%' }"
            styleClass="w-full [&_th]:!border-e [&_td]:!border-e [&_th]:!border-gray-300 [&_td]:!border-gray-300"
          >
            <ng-template pTemplate="header">
              <tr class="bg-primary">
                <th
                  class="p-3 text-start text-sm font-medium text-white"
                  colspan="6"
                >
                  Expected Annual Headcount (upto 2030)
                  <span class="font-normal text-xs">(To be filled for the KSA based facility only)</span>
                </th>
              </tr>
              <tr class="[&_th]:bg-[#F9FAFA]! [&_th]:text-[#4A4E5A]!">
                @for (year of yearColumns(); track $index) {
                <th class="p-3 text-start text-sm font-medium text-[#4A4E5A]">{{ year }}</th>
                }
              </tr>
            </ng-template>

            <ng-template
              pTemplate="body"
              let-row
            >
              <tr>
                @for (headcount of row.headcount; track $index) {
                <td class="border-t border-gray-300 p-3 text-center">
                  <app-summary-table-cell
                    [value]="headcount.value"
                    [isEmpty]="!headcount.value && headcount.value !== 0"
                    [hasError]="hasEntityFieldError(headcount.controlName)"
                    [hasComment]="hasEntityLevelComment(headcount.controlName)"
                    [isResolved]="isEntityLevelResolved(headcount.controlName)"
                    [beforeValue]="getBeforeValue(headcount.controlName, 'entityLevel')"
                    [afterValue]="getAfterValue(headcount.controlName, 'entityLevel')"
                    [showDiff]="shouldShowDiff(headcount.controlName, 'entityLevel')"
                  />
                </td>
                }
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
    </div>
    }

    <!-- Service Level -->
    <div class="flex flex-col gap-4">
      <h3 class="text-lg font-semibold text-[#4A4E5A]">Service Level</h3>
      @if (serviceLevel().length > 0) {
      <div class="overflow-x-auto">
        <div class="rounded-2xl overflow-hidden border border-gray-300">
          <p-table
            [value]="serviceLevel()"
            [tableStyle]="{ 'border-collapse': 'collapse', width: '100%' }"
            styleClass="w-full [&_th]:!border-e [&_td]:!border-e [&_th]:!border-gray-300 [&_td]:!border-gray-300"
          >
            <ng-template pTemplate="header">
              <tr class="[&>th:not([data-group])]:bg-[#F9FAFA]! [&>th:not([data-group])]:text-[#4A4E5A]!">
                <th
                  class="p-3 text-left text-sm font-semibold text-[#4A4E5A]"
                  rowspan="2"
                >Service Name</th>
                <th
                  class="p-3 text-left text-sm font-semibold text-[#4A4E5A]"
                  rowspan="2"
                >Expected Localization Date</th>
                <th
                  class="p-3 text-center text-sm font-semibold bg-primary! text-white!"
                  colspan="6"
                  data-group="true"
                >Expected Annual Headcount (To be filled for the KSA based facility only)</th>
                <th
                  class="p-3 text-center text-sm font-semibold bg-primary! text-white!"
                  colspan="6"
                  data-group="true"
                >Mention Y-o-Y expected Saudization % (To be filled for the KSA based facility only)</th>
                <th
                  class="p-3 text-left text-sm font-semibold text-[#4A4E5A]"
                  rowspan="2"
                >Key Measures to Upskill Saudis</th>
                <th
                  class="p-3 text-left text-sm font-semibold text-[#4A4E5A]"
                  rowspan="2"
                >Support Required from SEC</th>
              </tr>
              <tr class="[&_th]:bg-[#F9FAFA]! [&_th]:text-[#4A4E5A]!">
                @for (year of yearColumns(); track $index) {
                <th class="p-3 text-center text-sm font-semibold text-[#4A4E5A]">{{ year }}</th>
                }
                @for (year of yearColumns(); track $index) {
                <th class="p-3 text-center text-sm font-semibold text-[#4A4E5A]">{{ year }}</th>
                }
              </tr>
            </ng-template>

            <ng-template
              pTemplate="body"
              let-service
            >
              <tr>
                <td class="border-t border-gray-300 p-3">
                  <app-summary-table-cell
                    [value]="service.serviceName"
                    [isEmpty]="!service.serviceName"
                    [hasError]="hasServiceLevelFieldError(service.index, 'serviceName')"
                    [hasComment]="hasServiceLevelComment(service.index, 'serviceName')"
                    [isResolved]="isServiceLevelResolved(service.index, 'serviceName')"
                    [beforeValue]="getBeforeValue('serviceName', 'serviceLevel', service.index)"
                    [afterValue]="getAfterValue('serviceName', 'serviceLevel', service.index)"
                    [showDiff]="shouldShowDiff('serviceName', 'serviceLevel', service.index)"
                  />
                </td>
                <td class="border-t border-gray-300 p-3">
                  <app-summary-table-cell
                    [value]="service.expectedLocalizationDate"
                    [isEmpty]="!service.expectedLocalizationDate"
                    [hasError]="hasServiceLevelFieldError(service.index, 'expectedLocalizationDate')"
                    [hasComment]="hasServiceLevelComment(service.index, 'expectedLocalizationDate')"
                    [isResolved]="isServiceLevelResolved(service.index, 'expectedLocalizationDate')"
                    [beforeValue]="getBeforeValue('expectedLocalizationDate', 'serviceLevel', service.index)"
                    [afterValue]="getAfterValue('expectedLocalizationDate', 'serviceLevel', service.index)"
                    [showDiff]="shouldShowDiff('expectedLocalizationDate', 'serviceLevel', service.index)"
                  />
                </td>
                @for (yearCell of service.headcountYears; track $index) {
                <td class="border-t border-gray-300 p-3 text-center">
                  <app-summary-table-cell
                    [value]="yearCell.value"
                    [isEmpty]="!yearCell.value && yearCell.value !== 0"
                    [hasError]="hasServiceLevelFieldError(service.index, yearCell.controlName)"
                    [hasComment]="hasServiceLevelComment(service.index, yearCell.controlName)"
                    [isResolved]="isServiceLevelResolved(service.index, yearCell.controlName)"
                    [beforeValue]="getBeforeValue(yearCell.controlName, 'serviceLevel', service.index)"
                    [afterValue]="getAfterValue(yearCell.controlName, 'serviceLevel', service.index)"
                    [showDiff]="shouldShowDiff(yearCell.controlName, 'serviceLevel', service.index)"
                  />
                </td>
                }
                @for (year of service.years; track $index) {
                <td class="border-t border-gray-300 p-3 text-center">
                  <app-summary-table-cell
                    [value]="year.value"
                    [isEmpty]="!year.value && year.value !== 0"
                    [hasError]="hasServiceLevelFieldError(service.index, year.controlName)"
                    [hasComment]="hasServiceLevelComment(service.index, year.controlName)"
                    [isResolved]="isServiceLevelResolved(service.index, year.controlName)"
                    [beforeValue]="getBeforeValue(year.controlName, 'serviceLevel', service.index)"
                    [afterValue]="getAfterValue(year.controlName, 'serviceLevel', service.index)"
                    [showDiff]="shouldShowDiff(year.controlName, 'serviceLevel', service.index)"
                  />
                </td>
                }
                <td class="border-t border-gray-300 p-3">
                  <app-summary-table-cell
                    [value]="service.keyMeasuresToUpskillSaudis"
                    [isEmpty]="!service.keyMeasuresToUpskillSaudis"
                    [hasError]="hasServiceLevelFieldError(service.index, 'keyMeasuresToUpskillSaudis')"
                    [hasComment]="hasServiceLevelComment(service.index, 'keyMeasuresToUpskillSaudis')"
                    [isResolved]="isServiceLevelResolved(service.index, 'keyMeasuresToUpskillSaudis')"
                    [beforeValue]="getBeforeValue('keyMeasuresToUpskillSaudis', 'serviceLevel', service.index)"
                    [afterValue]="getAfterValue('keyMeasuresToUpskillSaudis', 'serviceLevel', service.index)"
                    [showDiff]="shouldShowDiff('keyMeasuresToUpskillSaudis', 'serviceLevel', service.index)"
                  />
                </td>
                <td class="border-t border-gray-300 p-3">
                  <app-summary-table-cell
                    [value]="service.mentionSupportRequiredFromSEC"
                    [isEmpty]="!service.mentionSupportRequiredFromSEC"
                    [hasError]="hasServiceLevelFieldError(service.index, 'mentionSupportRequiredFromSEC')"
                    [hasComment]="hasServiceLevelComment(service.index, 'mentionSupportRequiredFromSEC')"
                    [isResolved]="isServiceLevelResolved(service.index, 'mentionSupportRequiredFromSEC')"
                    [beforeValue]="getBeforeValue('mentionSupportRequiredFromSEC', 'serviceLevel', service.index)"
                    [afterValue]="getAfterValue('mentionSupportRequiredFromSEC', 'serviceLevel', service.index)"
                    [showDiff]="shouldShowDiff('mentionSupportRequiredFromSEC', 'serviceLevel', service.index)"
                  />
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
      } @else {
      <p class="text-sm text-gray-500">No service level details added</p>
      }
    </div>
  </div>
</div>
