@if (!planStore.isLoading()) {
<app-base-wizard-dialog
  [(visible)]="visibility"
  [(activeStep)]="activeStep"
  [steps]="steps()"
  [wizardTitle]="wizardTitle()"
  (onNextStep)="nextStep()"
  (onPreviousStep)="previousStep()"
  (onSaveAsDraft)="saveAsDraft()"
  [isLoading]="isLoading() || isLoadingPlan()"
  [isProcessing]="isProcessing()"
  [hideSaveAsDraft]="isViewMode() || isReviewMode() || isResubmitMode()"
  (onClose)="onClose()"
>
  @if (shouldShowStatusTag()) {
  <ng-container ngProjectAs="status">
    <app-base-tag
      [value]="statusLabel()"
      [color]="statusBadgeClass()"
    />
  </ng-container>
  }

  <ng-template [appStepContent]="1">
    <div class="flex flex-col gap-8">
      @if (shouldShowIncomingComments() && hasIncomingStep1Comments() && !showCommentState()) {
      <app-page-comment-box
        [commentTitle]="incomingCommentPersona() || 'Comment'"
        [commentText]="getIncomingStep1CommentText()"
      />
      }
      <app-service-localization-step-cover-page
        [isViewMode]="isViewMode() || isReviewMode() || isResubmitMode()"
        [pageTitle]="steps()[0].title"
        [(commentPhase)]="step1CommentPhase"
        [(selectedInputs)]="step1SelectedInputs"
        [selectedInputColor]="commentColor()"
        [pageComments]="step1Comments()"
        [commentTitle]="commentTitle() || 'Comments'"
        [showCommentState]="showCommentState()"
        [correctedFields]="step1CorrectedFields()"
        [originalPlanResponse]="originalPlanResponse()"
      ></app-service-localization-step-cover-page>
    </div>
  </ng-template>

  <ng-template [appStepContent]="2">
    <div class="flex flex-col gap-8">
      @if (shouldShowIncomingComments() && hasIncomingStep2Comments() && !showCommentState()) {
      <app-page-comment-box
        [commentTitle]="incomingCommentPersona() || 'Comment'"
        [commentText]="getIncomingStep2CommentText()"
      />
      }
      <app-service-localization-step-overview
        [isViewMode]="isViewMode() || isReviewMode() || isResubmitMode()"
        [isReviewMode]="isReviewMode()"
        [pageTitle]="steps()[1].title"
        [(commentPhase)]="step2CommentPhase"
        [(selectedInputs)]="step2SelectedInputs"
        [selectedInputColor]="commentColor()"
        [pageComments]="step2Comments()"
        [commentTitle]="commentTitle() || 'Comments'"
        [showCommentState]="showCommentState()"
        [correctedFields]="step2CorrectedFields()"
        [originalPlanResponse]="originalPlanResponse()"
      ></app-service-localization-step-overview>
    </div>
  </ng-template>

  <!-- Conditional step: Existing Saudi (appears before Direct Localization in step order) -->
  @if (showExistingSaudiStep() && existingSaudiStepIndex() > 0) {
  <ng-template [appStepContent]="existingSaudiStepIndex()">
    <div class="flex flex-col gap-8">
      @if (shouldShowIncomingComments() && hasIncomingStep3Comments() && !showCommentState()) {
      <app-page-comment-box
        [commentTitle]="incomingCommentPersona() || 'Comment'"
        [commentText]="getIncomingStep3CommentText()"
      />
      }
      <app-service-localization-step-existing-saudi
        [isViewMode]="isViewMode() || isReviewMode() || isResubmitMode()"
        [isReviewMode]="isReviewMode()"
        [pageTitle]="steps()[existingSaudiStepIndex() - 1].title"
        [(commentPhase)]="step3CommentPhase"
        [(selectedInputs)]="step3SelectedInputs"
        [selectedInputColor]="commentColor()"
        [pageComments]="step3Comments()"
        [commentTitle]="commentTitle() || 'Comments'"
        [showCommentState]="showCommentState()"
        [correctedFields]="step3CorrectedFields()"
        [originalPlanResponse]="originalPlanResponse()"
      ></app-service-localization-step-existing-saudi>
    </div>
  </ng-template>
  }

  <!-- Conditional step: Direct Localization -->
  @if (showDirectLocalizationStep() && directLocalizationStepIndex() > 0) {
  <ng-template [appStepContent]="directLocalizationStepIndex()">
    <div class="flex flex-col gap-8">
      @if (shouldShowIncomingComments() && hasIncomingStep4Comments() && !showCommentState()) {
      <app-page-comment-box
        [commentTitle]="incomingCommentPersona() || 'Comment'"
        [commentText]="getIncomingStep4CommentText()"
      />
      }
      <app-service-localization-step-direct-localization
        [isViewMode]="isViewMode() || isReviewMode() || isResubmitMode()"
        [isReviewMode]="isReviewMode()"
        [pageTitle]="steps()[directLocalizationStepIndex() - 1].title"
        [(commentPhase)]="step4CommentPhase"
        [(selectedInputs)]="step4SelectedInputs"
        [selectedInputColor]="commentColor()"
        [pageComments]="step4Comments()"
        [commentTitle]="commentTitle() || 'Comments'"
        [showCommentState]="showCommentState()"
        [correctedFields]="step4CorrectedFields()"
        [originalPlanResponse]="originalPlanResponse()"
      ></app-service-localization-step-direct-localization>
    </div>
  </ng-template>
  }

  <!-- Summary step is always last -->
  <ng-template [appStepContent]="summaryStepIndex()">
    <app-service-localization-step-summary
      [isViewMode]="isViewMode()"
      [commentTitle]="commentTitle() || 'Comments' "
      [signature]="planSignature()"
      [pageComments]="collectAllPageComments()"
      [includeExistingSaudi]="showExistingSaudiStep()"
      [includeDirectLocalization]="showDirectLocalizationStep()"
      [coverStepNumber]="stepIndex('cover')"
      [overviewStepNumber]="stepIndex('overview')"
      [existingSaudiStepNumber]="stepIndex('existingSaudi')"
      [directLocalizationStepNumber]="stepIndex('directLocalization')"
      [step1Comments]="step1Comments()"
      [step2Comments]="step2Comments()"
      [step3Comments]="step3Comments()"
      [step4Comments]="step4Comments()"
      [step1CorrectedFields]="step1CorrectedFieldIds()"
      [step2CorrectedFields]="step2CorrectedFieldIds()"
      [step3CorrectedFields]="step3CorrectedFieldIds()"
      [step4CorrectedFields]="step4CorrectedFieldIds()"
      [originalPlanResponse]="originalPlanResponse()"
      #summaryComponent
      (onEditStep)="navigateToStep($event)"
      (onValidationErrorsChange)="updateValidationErrors($event)"
    ></app-service-localization-step-summary>
  </ng-template>

  <ng-container ngProjectAs="final-step-action">
    @if (activeStep() === summaryStepIndex() && !isViewMode()) {
    @if (isReviewMode()) {
    <p-button
      [label]="'Reject'"
      severity="danger"
      [disabled]="!canApproveOrReject()"
      (click)="onReject()"
    ></p-button>
    <p-button
      [label]="'Approve & Forward'"
      [disabled]="!canApproveOrReject()"
      (click)="onApproveAndForward()"
    ></p-button>
    } @else if (isResubmitMode()) {
    <p-button
      [label]="'Resubmit'"
      (click)="onSummarySubmitClick()"
      [disabled]="!allowUserToResubmit()"
    ></p-button>
    } @else {
    <p-button
      [label]="'Submit'"
      (click)="onSummarySubmitClick()"
    ></p-button>
    }
    }
  </ng-container>

  <ng-container ngProjectAs="more-actions">
    @if(canOpenTimeline()){
    <p-button
      label="Timeline"
      icon="icon-list"
      text
      severity="secondary"
      (click)="timelineVisibility.set(true)"
    ></p-button>
    }
    @if (isReviewMode() && activeStep() === stepsCount()) {
    <p-button
      text
      (click)="onSendBackToInvestor()"
      styleClass="p-0!"
    >
      <span class="underline text-md font-semibold">Send Back to Investor</span>
    </p-button>
    }
    @if((isReviewMode() || isResubmitMode()) && activeStep() <stepsCount()){
      <p-button
      [label]="'Add Comments'"
      text
      icon="icon-message-circle"
      severity="secondary"
      (click)="onAddComment()"
      [disabled]="isAddCommentButtonDisabled()"
    ></p-button>
      }
  </ng-container>
</app-base-wizard-dialog>
}

@if(showSubmissionModal()){
<!-- Submission Confirmation Modal -->
<app-submission-confirmation-modal
  [(visible)]="showSubmissionModal"
  [(existingSignature)]="existingSignature"
  [contactInfo]="contactInfo()"
  (onConfirm)="onSubmissionConfirm($event)"
  (onCancel)="onSubmissionCancel()"
/>
}

<!-- Confirm Leave Dialog -->
<app-general-confirmation-dialog
  [(visible)]="showConfirmLeaveDialog"
  [isLoading]="isProcessing()"
  (onCancel)="saveAsDraft()"
  [cancelLabel]="'plans.confirmation.saveAsDraft' | translate"
  [icon]="'icon-info'"
  [confirmButtonSeverity]="'danger'"
  [title]="'plans.confirmation.onLeaveTitle' | translate"
  [description]="'plans.confirmation.onLeaveDesc' | translate"
  (confirmed)="onConfirmLeave()"
  [confirmationLabel]="'plans.confirmation.cancelLabel' | translate"
></app-general-confirmation-dialog>

<!-- Confirm Leave Dialog -->
<!-- <app-confirm-leave-dialog
  [(visible)]="showConfirmLeaveDialog"
  (onLeave)="onConfirmLeave()"
  (onContinueEditing)="onContinueEditing()"
/> -->

<app-timeline-dialog
  [(dialogVisible)]="timelineVisibility"
  [planId]="planId()"
/>

@if(showSendBackConfirmationDialog()){
<app-general-confirmation-dialog
  [(visible)]="showSendBackConfirmationDialog"
  [title]="'Are you sure you want to send back the plan?'"
  [description]="'This action cannot be undone and the plan will go directly to the investor.'"
  [confirmationLabel]="'Send Back'"
  [cancelLabel]="'Cancel'"
  [icon]="'icon-info'"
  (confirmed)="onConfirmSendBack()"
  (onCancel)="onCancelSendBack()"
  [isLoading]="isProcessing()"
/>
}

<!-- Approve Confirmation Dialog -->
@if(showApproveConfirmationDialog()){
<app-approve-reject-dialog
  [(visible)]="showApproveConfirmationDialog"
  [title]="'Are you sure you want to approve this plan and forward it to the Division Manager for review?'"
  [label]="'Approval Note'"
  [placeholder]="'Enter approval note'"
  [maxLength]="255"
  [(note)]="approvalNote"
  [confirmationLabel]="'Approve and Forward'"
  [cancelLabel]="'Cancel'"
  [icon]="'icon-info'"
  (confirmed)="onConfirmApprove()"
  (onCancel)="onCancelApprove()"
  [isLoading]="isProcessing()"
/>
}

<!-- Reject Reason Dialog -->
@if(showRejectReasonDialog()){
<app-approve-reject-dialog
  [(visible)]="showRejectReasonDialog"
  [title]="'Rejection Reason'"
  [label]="'Rejection Reason'"
  [placeholder]="'Enter rejection reason'"
  [maxLength]="255"
  [(note)]="rejectionReason"
  [confirmationLabel]="'Reject'"
  [cancelLabel]="'Back'"
  [icon]="'icon-info'"
  [isRequired]="true"
  (confirmed)="onProceedReject()"
  (onCancel)="onCancelRejectReason()"
  [isLoading]="isProcessing()"
/>
}

<!-- Reject Confirmation Dialog -->
@if(showRejectConfirmationDialog()){
<app-general-confirmation-dialog
  [(visible)]="showRejectConfirmationDialog"
  [title]="'Are you sure you want to reject the plan as final rejection?'"
  [description]="'This action cannot be undone, and the plan will proceed to the investor.'"
  [confirmationLabel]="'Confirm Rejection'"
  [cancelLabel]="'Cancel'"
  [icon]="'icon-info'"
  [confirmButtonSeverity]="'danger'"
  (confirmed)="onConfirmReject()"
  (onCancel)="onCancelRejectConfirmation()"
  [isLoading]="isProcessing()"
/>
}