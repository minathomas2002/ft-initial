<div
  class="rounded-xl"
  #tableWrapper
>
  <p-table
    [value]="rows()"
    [scrollable]="true"
    [scrollHeight]="scrollHeight()"
    class="rounded-xl"
  >
    <ng-template pTemplate="header">
      @if(groupHeader().length > 0) {
      <!-- First header row with group headers -->
      <tr>
        @for (cell of groupHeader(); track cell) {
        <th
          [attr.colspan]="cell.colspan"
          [attr.rowspan]="cell.rowspan"
          [attr.data-group]="cell.dataGroup"
          [class]="cell.dataGroup
            ? 'p-3 border border-gray-200 text-center font-medium! bg-primary! text-white!'
            : (cell.label ? 'p-3 border border-gray-200 text-left font-medium! bg-gray-50! text-gray-700!' : 'bg-white! border-0!')"
        >{{ cell.label }}</th>
        }
        <!-- Delete button column header with rowspan -->
        <th
          class="p-3 !border !border-gray-200 !w-[48px] !bg-gray-50 !text-gray-700"
          rowspan="2"
        ></th>
      </tr>
      <!-- Second header row with year columns only (for grouped headers) -->
      <tr class="bg-gray-50">
        @for (key of secondRowKeys(); track key) {
        <th class="p-3 !border !border-gray-200 !text-center !font-medium !whitespace-nowrap !bg-gray-50 !text-gray-700">
          <span>{{
            customHeaderLabels()[key]
            ? customHeaderLabels()[key]
            : key === 'keyActivity'
            ? ('opportunity.wizard.keyActivity' | translate)
            : (key | camelCaseToWord)
            }}</span>@if(customTextBesideHeaders()[key]){<span class="font-light">{{ customTextBesideHeaders()[key] }}</span>}
          @if(headerTooltips()[key]){
          <i
            class="icon-info text-sm ms-2 text-gray-400"
            [pTooltip]="tooltipContent"
            tooltipPosition="top"
          ></i>
          <ng-template #tooltipContent>
            <div class="flex flex-col gap-2 text-start">
              <p>{{ headerTooltips()[key] }}</p>
            </div>
          </ng-template>
          }
        </th>
        }
      </tr>
      } @else {
      <!-- Default single header row when no groupHeader -->
      <tr class="bg-gray-50">
        @if(showIndexColumn()){
        <th class="p-3 !border !border-gray-200 !text-left !font-medium !whitespace-nowrap !bg-gray-50 !text-gray-700 rounded-tl-xl">
          <span>{{ indexColumnLabel() }}</span>
        </th>
        } @for (key of keys(); track key) {
        <th
          class="p-3 !border !border-gray-200 !text-left !font-medium !whitespace-nowrap !bg-gray-50 !text-gray-700"
          [class.rounded-tl-xl]="$index === 0 && !showIndexColumn()"
          [attr.colspan]="headerColspan()[key] || null"
          [attr.rowspan]="headerRowspan()[key] || null"
        >
          <span>{{
            customHeaderLabels()[key]
            ? customHeaderLabels()[key]
            : key === 'keyActivity'
            ? ('opportunity.wizard.keyActivity' | translate)
            : (key | camelCaseToWord)
            }}</span>@if(customTextBesideHeaders()[key]){<span class="font-light">{{ customTextBesideHeaders()[key] }}</span>}
          @if(headerTooltips()[key]){
          @if(headerTooltips()[key]){
          <i
            class="icon-info text-sm ms-2 text-gray-400"
            [pTooltip]="tooltipContent"
            tooltipPosition="top"
          ></i>
          <ng-template #tooltipContent>
            <div class="flex flex-col gap-2 text-start">
              <p>{{ headerTooltips()[key] }}</p>
            </div>
          </ng-template>
          }
          }
        </th>
        }
        <th class="p-3 !border !border-gray-200 !w-[48px] !bg-gray-50 !text-gray-700 rounded-tr-xl"></th>
      </tr>
      }
    </ng-template>
    <ng-template
      pTemplate="body"
      let-object
      let-rowIndex="rowIndex"
    >
      <tr #tableRow>
        @if (itemTemplate) {
        <ng-container *ngTemplateOutlet="
            itemTemplate;
            context: {
              $implicit: getItemControl(rowIndex)!,
              index: rowIndex,
              itemValue: object
            }
          "></ng-container>
        <td class="!p-3 !border !border-gray-200 !text-center">
          @if(!hideDeleteButton()){ @if(rowIndex > 0 || rows().length > 1){
          <p-button
            severity="danger"
            [icon]="'icon-trash-2'"
            text
            (onClick)="onDeleteHandler(rowIndex)"
          />
          } }
        </td>
        }
      </tr>
    </ng-template>
    <ng-template pTemplate="footer">
      <tr>
        <td
          [attr.colspan]="keys().length + 1"
          class="!p-3 !border !border-gray-200 !rounded-br-xl !rounded-bl-xl"
        >
          @if(!hideAddButton()){
          <p-button
            text
            [icon]="'icon-plus'"
            [label]="addButtonMessage()"
            (onClick)="onAddHandler()"
            [disabled]="rows().length >= maxItems()"
          />
          }
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>